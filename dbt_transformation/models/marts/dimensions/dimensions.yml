version: 2

models:
  - name: dim_customers
    description: "SCD Type 2 customer dimension tracking address changes over time"
    columns:
      - name: customer_key
        description: "Surrogate key (SHA-256 hash) - unique per version"
        tests:
          - unique
          - not_null
      
      - name: customer_id
        description: "Business key from source system"
        tests:
          - not_null
          - relationships:
              to: source('stg', 'customers')
              field: customer_id
      
      - name: customer_id_active
        description: "Test that only one active version exists per customer"
        tests:
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - customer_id
                - is_active
              where: "is_active = 1"
      
      - name: email
        description: "Customer email address"
        tests:
          - not_null
      
      - name: address_effective_date
        description: "When this address version became effective"
        tests:
          - not_null
      
      - name: address_expiry_date
        description: "When this address version expired (NULL if active)"
      
      - name: is_active
        description: "Flag indicating current version"
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]
      
      - name: signup_date
        description: "When customer first signed up"
        tests:
          - not_null
    
    tests:
      - dbt_utils.expression_is_true:
          expression: "address_effective_date <= coalesce(address_expiry_date, current_date())"
          config:
            where: "address_expiry_date is not null"
      
      - dbt_utils.expression_is_true:
          expression: "case when is_active = 1 then address_expiry_date is null else address_expiry_date is not null end"
          name: active_records_have_no_expiry

  - name: dim_agents
    description: "SCD Type 2 agent dimension tracking experience level changes over time"
    columns:
      - name: agent_key
        description: "Surrogate key (SHA-256 hash) - unique per version"
        tests:
          - unique
          - not_null
      
      - name: agent_id
        description: "Business key from source system"
        tests:
          - not_null
          - relationships:
              to: source('stg', 'agents')
              field: agent_id
      
      - name: agent_id_active
        description: "Test that only one active version exists per agent"
        tests:
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - agent_id
                - is_active
              where: "is_active = 1"
      
      - name: experience
        description: "Agent experience level (Junior, Intermediate, Senior)"
        tests:
          - not_null
          - accepted_values:
              values: ['Junior', 'Intern', 'Senior', 'Mid-Level']
      
      - name: experience_effective_date
        description: "When this experience level became effective"
        tests:
          - not_null
      
      - name: is_active
        description: "Flag indicating current version"
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]
    
    tests:
      - dbt_utils.expression_is_true:
          expression: "experience_effective_date <= coalesce(experience_expiry_date, current_date())"
          config:
            where: "experience_expiry_date is not null"

  - name: dim_date
    description: "Date dimension for time-based analysis"
    columns:
      - name: date_day
        description: "Primary date key"
        tests:
          - unique
          - not_null
      
      - name: day_of_week
        description: "Day of week (1-7)"
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7]
      
      - name: month_of_year
        description: "Month number (1-12)"
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]